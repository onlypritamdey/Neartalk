<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neartalk (Serverless)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6">Neartalk 🔗</h1>
  <div id="status" class="mb-6 text-yellow-300">Idle</div>

  <!-- Host button -->
  <button id="createLinkBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 mb-6">
    Create Link
  </button>

  <!-- Generated link -->
  <div id="linkBox" class="hidden w-full max-w-md bg-gray-800 p-4 rounded mb-6">
    <p class="mb-2 font-semibold">Share this link:</p>
    <textarea id="generatedLink" class="w-full p-2 text-black rounded mb-2"></textarea>
    <button onclick="copyText('generatedLink')" class="px-3 py-1 bg-gray-600 rounded">Copy</button>
  </div>

  <!-- Reply link -->
  <div id="replyBox" class="hidden w-full max-w-md bg-gray-800 p-4 rounded mb-6">
    <p class="mb-2 font-semibold">Send this reply link back:</p>
    <textarea id="replyLink" class="w-full p-2 text-black rounded mb-2"></textarea>
    <button onclick="copyText('replyLink')" class="px-3 py-1 bg-gray-600 rounded">Copy</button>
  </div>

  <!-- Chat -->
  <div id="chat" class="hidden w-full max-w-md">
    <div id="messages" class="h-64 overflow-y-auto border border-gray-600 p-2 rounded mb-2"></div>
    <div class="flex">
      <input id="messageInput" class="flex-1 p-2 text-black rounded-l" placeholder="Type message...">
      <button id="sendBtn" class="px-4 py-2 bg-purple-600 rounded-r hover:bg-purple-700">Send</button>
    </div>
  </div>

<script>
let pc, dataChannel;
let offerCreated = false;

function updateStatus(msg, color="text-yellow-300") {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = color;
}

function addMessage(sender, text) {
  const div = document.createElement("div");
  div.textContent = sender + ": " + text;
  document.getElementById("messages").appendChild(div);
}

function showChat() {
  document.getElementById("chat").classList.remove("hidden");
}

function setupConnection() {
  if (pc) return pc; // reuse same connection
  pc = new RTCPeerConnection();

  pc.onicecandidate = async e => {
    if (!e.candidate && pc.localDescription) {
      const desc = btoa(JSON.stringify(pc.localDescription));
      if (pc.localDescription.type === "offer") {
        const link = location.origin + location.pathname + "#offer=" + desc;
        document.getElementById("generatedLink").value = link;
        document.getElementById("linkBox").classList.remove("hidden");
      } else {
        const link = location.origin + location.pathname + "#answer=" + desc;
        document.getElementById("replyLink").value = link;
        document.getElementById("replyBox").classList.remove("hidden");
      }
    }
  };

  pc.ondatachannel = e => {
    dataChannel = e.channel;
    dataChannel.onmessage = e => addMessage("Peer", e.data);
    showChat();
    updateStatus("Connected ✅", "text-green-400");
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === "connected") {
      updateStatus("Connected ✅", "text-green-400");
    }
  };

  return pc;
}

// HOST creates offer
document.getElementById("createLinkBtn").onclick = async () => {
  const pc = setupConnection();
  dataChannel = pc.createDataChannel("chat");
  dataChannel.onmessage = e => addMessage("Peer", e.data);
  showChat();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  offerCreated = true;
  updateStatus("Offer created. Share the link", "text-blue-300");
};

// On load, check hash
(async () => {
  const hash = new URLSearchParams(window.location.hash.slice(1));
  if (hash.has("offer")) {
    // Peer side
    const pc = setupConnection();
    const offer = JSON.parse(atob(hash.get("offer")));
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    updateStatus("Reply link ready. Send back to host", "text-purple-300");
  }
  else if (hash.has("answer")) {
    // Host side receives answer
    if (!offerCreated) {
      // Host reopened the page -> lost session
      updateStatus("❌ Offer session lost. Please start again", "text-red-400");
      return;
    }
    const answer = JSON.parse(atob(hash.get("answer")));
    await pc.setRemoteDescription(answer);
    updateStatus("Connected ✅", "text-green-400");
  }
})();

// Sending messages
document.getElementById("sendBtn").onclick = () => {
  const text = document.getElementById("messageInput").value;
  if (text && dataChannel?.readyState === "open") {
    dataChannel.send(text);
    addMessage("You", text);
    document.getElementById("messageInput").value = "";
  }
};

function copyText(id) {
  const el = document.getElementById(id);
  el.select();
  document.execCommand("copy");
}
</script>
</body>
</html>
