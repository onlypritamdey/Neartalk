<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neartalk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

  <h1 class="text-3xl font-bold mb-4">Neartalk ðŸ”—</h1>

  <!-- Status Bar -->
  <div id="statusBar" class="mb-6 px-4 py-2 bg-gray-700 rounded text-yellow-300">
    Status: Idle
  </div>

  <!-- Host Section -->
  <div class="mb-6 w-full text-center">
    <button id="createOfferBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Start Session</button>
    <div id="offerQR" class="mt-4"></div>
  </div>

  <!-- Join Section -->
  <div class="mb-6 w-full text-center">
    <button id="scanOfferBtn" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700">Join (Scan Offer)</button>
    <button id="scanAnswerBtn" class="ml-2 px-4 py-2 bg-yellow-600 rounded hover:bg-yellow-700">Scan Answer</button>
    <video id="cameraPreview" class="mt-4 hidden w-64 border border-gray-500"></video>
    <canvas id="qrCanvas" class="hidden"></canvas>
  </div>

  <!-- Answer QR -->
  <div id="answerQR" class="mb-6"></div>

  <!-- Chat Section -->
  <div id="chatSection" class="hidden w-full max-w-md">
    <div id="messages" class="h-64 overflow-y-auto border border-gray-600 p-2 rounded mb-2"></div>
    <div class="flex">
      <input id="messageInput" class="flex-1 p-2 text-black rounded-l" placeholder="Type message...">
      <button id="sendBtn" class="px-4 py-2 bg-purple-600 rounded-r hover:bg-purple-700">Send</button>
    </div>
  </div>

  <script>
    let pc, dataChannel;
    let scanningMode = null; // "offer" or "answer"

    const statusBar = document.getElementById("statusBar");
    const createOfferBtn = document.getElementById("createOfferBtn");
    const offerQR = document.getElementById("offerQR");
    const answerQR = document.getElementById("answerQR");
    const scanOfferBtn = document.getElementById("scanOfferBtn");
    const scanAnswerBtn = document.getElementById("scanAnswerBtn");
    const cameraPreview = document.getElementById("cameraPreview");
    const qrCanvas = document.getElementById("qrCanvas");
    const chatSection = document.getElementById("chatSection");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    function updateStatus(text, color = "text-yellow-300") {
      statusBar.textContent = "Status: " + text;
      statusBar.className = "mb-6 px-4 py-2 bg-gray-700 rounded " + color;
    }

    function setupConnection() {
      pc = new RTCPeerConnection();
      pc.ondatachannel = e => {
        dataChannel = e.channel;
        dataChannel.onmessage = e => addMessage("Peer", e.data);
        showChat();
        updateStatus("Connected âœ…", "text-green-400");
      };
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === "connected") {
          updateStatus("Connected âœ…", "text-green-400");
        }
      };
    }

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.textContent = sender + ": " + text;
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showChat() {
      chatSection.classList.remove("hidden");
    }

    createOfferBtn.onclick = async () => {
      setupConnection();
      dataChannel = pc.createDataChannel("chat");
      dataChannel.onmessage = e => addMessage("Peer", e.data);
      showChat();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      new QRCode(offerQR, JSON.stringify(offer));

      updateStatus("Offer created. Waiting for peer to scan...", "text-blue-300");
    };

    scanOfferBtn.onclick = () => startScanning("offer");
    scanAnswerBtn.onclick = () => startScanning("answer");

    function startScanning(mode) {
      scanningMode = mode;
      updateStatus("Scanning QR...", "text-yellow-300");
      cameraPreview.classList.remove("hidden");
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          cameraPreview.srcObject = stream;
          cameraPreview.setAttribute("playsinline", true);
          cameraPreview.play();
          requestAnimationFrame(tick);
        });
    }

    function stopScanning() {
      const stream = cameraPreview.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      cameraPreview.classList.add("hidden");
    }

    async function handleScannedData(data) {
      stopScanning();
      if (scanningMode === "offer") {
        setupConnection();
        const offer = JSON.parse(data);
        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        new QRCode(answerQR, JSON.stringify(answer));
        updateStatus("Answer created. Waiting for host to scan...", "text-purple-300");
      } else if (scanningMode === "answer") {
        const answer = JSON.parse(data);
        await pc.setRemoteDescription(answer);
        updateStatus("Connected âœ…", "text-green-400");
      }
    }

    function tick() {
      if (cameraPreview.readyState === cameraPreview.HAVE_ENOUGH_DATA) {
        qrCanvas.width = cameraPreview.videoWidth;
        qrCanvas.height = cameraPreview.videoHeight;
        const ctx = qrCanvas.getContext("2d");
        ctx.drawImage(cameraPreview, 0, 0, qrCanvas.width, qrCanvas.height);
        const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          handleScannedData(code.data);
          return;
        }
      }
      requestAnimationFrame(tick);
    }

    sendBtn.onclick = () => {
      const text = messageInput.value;
      if (text && dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(text);
        addMessage("You", text);
        messageInput.value = "";
      }
    };
  </script>
</body>
</html>
