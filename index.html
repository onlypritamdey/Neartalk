<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neartalk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

  <h1 class="text-3xl font-bold mb-6">Neartalk ðŸ”—</h1>

  <!-- Host Section -->
  <div class="mb-6 w-full text-center">
    <button id="createOfferBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Start Session</button>
    <div id="offerQR" class="mt-4"></div>
  </div>

  <!-- Join Section -->
  <div class="mb-6 w-full text-center">
    <input type="file" accept="image/*" id="scanOfferInput" class="hidden">
    <button id="scanOfferBtn" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700">Join by Scanning Offer</button>
    <video id="cameraPreview" class="mt-4 hidden w-64 border border-gray-500"></video>
  </div>

  <!-- Answer QR -->
  <div id="answerQR" class="mb-6"></div>

  <!-- Chat Section -->
  <div id="chatSection" class="hidden w-full max-w-md">
    <div id="messages" class="h-64 overflow-y-auto border border-gray-600 p-2 rounded mb-2"></div>
    <div class="flex">
      <input id="messageInput" class="flex-1 p-2 text-black rounded-l" placeholder="Type message...">
      <button id="sendBtn" class="px-4 py-2 bg-purple-600 rounded-r hover:bg-purple-700">Send</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let pc, dataChannel;

    const createOfferBtn = document.getElementById("createOfferBtn");
    const offerQR = document.getElementById("offerQR");
    const answerQR = document.getElementById("answerQR");
    const scanOfferBtn = document.getElementById("scanOfferBtn");
    const scanOfferInput = document.getElementById("scanOfferInput");
    const cameraPreview = document.getElementById("cameraPreview");
    const chatSection = document.getElementById("chatSection");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    function setupConnection() {
      pc = new RTCPeerConnection();
      pc.ondatachannel = e => {
        dataChannel = e.channel;
        dataChannel.onmessage = e => addMessage("Peer", e.data);
        showChat();
      };
    }

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.textContent = sender + ": " + text;
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showChat() {
      chatSection.classList.remove("hidden");
    }

    createOfferBtn.onclick = async () => {
      setupConnection();
      dataChannel = pc.createDataChannel("chat");
      dataChannel.onmessage = e => addMessage("Peer", e.data);
      showChat();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      new QRCode(offerQR, JSON.stringify(offer));
    };

    scanOfferBtn.onclick = async () => {
      scanOfferInput.click();
    };

    scanOfferInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = async () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
        if (code) {
          setupConnection();
          const offer = JSON.parse(code.data);
          await pc.setRemoteDescription(offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          new QRCode(answerQR, JSON.stringify(answer));
        }
      };
      img.src = URL.createObjectURL(file);
    };

    // When scanning the answer QR
    answerQR.onclick = () => {
      scanOfferInput.click();
    };

    sendBtn.onclick = () => {
      const text = messageInput.value;
      if (text && dataChannel.readyState === "open") {
        dataChannel.send(text);
        addMessage("You", text);
        messageInput.value = "";
      }
    };
  </script>
</body>
</html>
