<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NearTalk — QR P2P (Safari/TURN)</title>
<style>
  body { font-family: sans-serif; padding: 1em; background: #fafafa; }
  button { margin: 0.3em; padding: 0.5em 1em; }
  #log { background: #fff; border: 1px solid #ccc; padding: 0.5em; height: 200px; overflow-y: auto; }
  img { max-width: 100%; }
</style>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<h2>NearTalk — QR P2P (Safari/TURN)</h2>
<button id="createBtn">Create (Offer)</button>
<button id="joinBtn">Join (Answer)</button>

<div style="margin-top:1em;">
  <button id="qrModeBtn">QR</button>
  <button id="manualModeBtn">Manual</button>
</div>

<div id="qrSection" style="display:block; margin-top:1em;">
  <div id="qrcode"></div>
  <div id="reader" style="width:300px; margin-top:1em;"></div>
</div>

<div id="manualSection" style="display:none; margin-top:1em;">
  <textarea id="signalIn" placeholder="Paste signal here" style="width:100%;height:80px;"></textarea>
  <button id="signalBtn">Submit Signal</button>
</div>

<h3>Debug Log</h3>
<div id="log"></div>

<script>
const logEl = document.getElementById('log');
function log(msg) {
  const time = new Date().toLocaleTimeString();
  logEl.innerHTML += `[${time}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

log("🔒 Secure context check: " + (location.protocol === 'https:' ? "OK (https)" : "❌ Not secure"));

let peer;
let html5QrCode;
let isInitiator = false;

const iceServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  {
    urls: 'turn:relay1.expressturn.com:3478',
    username: 'efree',
    credential: 'efreepass'
  }
];

function createPeer(initiator, incomingSignal=null) {
  log(`Creating peer (initiator=${initiator})…`);
  peer = new SimplePeer({
    initiator,
    trickle: false,
    config: { iceServers }
  });

  peer.on('signal', data => {
    log("📡 Generated signal. Show/Send to other peer.");
    const json = JSON.stringify(data);
    showQR(json);
  });

  peer.on('connect', () => {
    log("✅ Peer connected!");
    peer.send("Hello from " + (initiator ? "initiator" : "receiver"));
  });

  peer.on('data', d => {
    log("💬 Received: " + d.toString());
  });

  peer.on('error', err => {
    log("❌ Peer error: " + err);
  });

  peer.on('close', () => {
    log("🔌 Peer closed");
  });

  if (incomingSignal) {
    log("📥 Applying incoming signal");
    peer.signal(incomingSignal);
  }
}

function showQR(data) {
  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), {
    text: data,
    width: 256,
    height: 256
  });
}

function startQRScanner(onResult) {
  html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices => {
    if (!devices.length) throw "No cameras found";
    let backCam = devices.find(d => /back|rear/i.test(d.label)) || devices[0];
    log("📷 Using camera: " + backCam.label);
    html5QrCode.start(
      { deviceId: { exact: backCam.id } },
      { fps: 10, qrbox: 250 },
      decodedText => {
        log("🔍 QR scanned");
        html5QrCode.stop();
        onResult(decodedText);
      },
      err => {}
    );
  }).catch(err => log("Camera error: " + err));
}

// UI handlers
document.getElementById("createBtn").onclick = () => {
  isInitiator = true;
  createPeer(true);
};

document.getElementById("joinBtn").onclick = () => {
  isInitiator = false;
  startQRScanner(result => {
    try {
      const signal = JSON.parse(result);
      createPeer(false, signal);
    } catch (e) {
      log("❌ Invalid QR content");
    }
  });
};

document.getElementById("signalBtn").onclick = () => {
  try {
    const signal = JSON.parse(document.getElementById("signalIn").value);
    peer.signal(signal);
  } catch (e) {
    log("❌ Bad signal JSON");
  }
};

document.getElementById("qrModeBtn").onclick = () => {
  document.getElementById("qrSection").style.display = "block";
  document.getElementById("manualSection").style.display = "none";
};

document.getElementById("manualModeBtn").onclick = () => {
  document.getElementById("qrSection").style.display = "none";
  document.getElementById("manualSection").style.display = "block";
};
</script>
</body>
</html>
