<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NearTalk ‚Äî Auto QR P2P</title>
<style>
  body { font-family: sans-serif; padding: 1em; background: #fafafa; }
  button { margin: 0.3em; padding: 0.5em 1em; }
  #log { background: #fff; border: 1px solid #ccc; padding: 0.5em; height: 200px; overflow-y: auto; }
  img { max-width: 100%; }
</style>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<h2>NearTalk ‚Äî Auto QR P2P</h2>
<button id="createBtn">Create (Offer)</button>
<button id="joinBtn">Join (Answer)</button>

<div id="qrSection" style="margin-top:1em;">
  <div id="qrcode"></div>
  <div id="reader" style="width:300px; margin-top:1em;"></div>
</div>

<h3>Debug Log</h3>
<div id="log"></div>

<script>
const logEl = document.getElementById('log');
function log(msg) {
  const time = new Date().toLocaleTimeString();
  logEl.innerHTML += `[${time}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

let peer, html5QrCode, isInitiator;
const qrDiv = document.getElementById("qrcode");

const iceServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  {
    urls: 'turn:relay1.expressturn.com:3478',
    username: 'efree',
    credential: 'efreepass'
  }
];

function createPeer(initiator, incomingSignal=null) {
  peer = new SimplePeer({
    initiator,
    trickle: false,
    config: { iceServers }
  });

  peer.on('signal', data => {
    const json = JSON.stringify(data);
    if (initiator && !incomingSignal) {
      // First offer (Device A shows QR)
      showQR(json);
      log("üì° Offer created ‚Äî show QR to Device B");
    } else if (!initiator && incomingSignal) {
      // Device B (answer after scanning offer)
      showQR(json);
      log("üì° Answer created ‚Äî show QR back to Device A");
    } else if (initiator && incomingSignal) {
      // Device A scanned Device B‚Äôs answer
      log("üì• Answer applied, waiting for connect...");
    }
  });

  peer.on('connect', () => {
    log("‚úÖ Peer connected!");
    peer.send("Hello from " + (initiator ? "Device A" : "Device B"));
  });

  peer.on('data', d => log("üí¨ Received: " + d.toString()));
  peer.on('error', err => log("‚ùå Peer error: " + err));
  peer.on('close', () => log("üîå Peer closed"));

  if (incomingSignal) {
    try {
      peer.signal(incomingSignal);
    } catch (e) {
      log("‚ùå Failed to apply signal: " + e);
    }
  }
}

function showQR(data) {
  qrDiv.innerHTML = "";
  new QRCode(qrDiv, {
    text: data,
    width: 256,
    height: 256
  });
}

function startQRScanner(onResult) {
  html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices => {
    let backCam = devices.find(d => /back|rear/i.test(d.label)) || devices[0];
    html5QrCode.start(
      { deviceId: { exact: backCam.id } },
      { fps: 10, qrbox: 250 },
      decodedText => {
        log("üîç QR scanned");
        html5QrCode.stop();
        onResult(decodedText);
      },
      err => {}
    ).catch(e => log("Camera error: " + e));
  });
}

// Device A (Offer)
document.getElementById("createBtn").onclick = () => {
  isInitiator = true;
  createPeer(true);
  log("üëâ Show this QR to Device B to join");
  startQRScanner(result => {
    try {
      const signal = JSON.parse(result);
      log("üì• Scanned Device B‚Äôs answer");
      peer.signal(signal);
    } catch {
      log("‚ùå Bad QR content");
    }
  });
};

// Device B (Answer)
document.getElementById("joinBtn").onclick = () => {
  isInitiator = false;
  log("üì∑ Scan Device A‚Äôs QR to join");
  startQRScanner(result => {
    try {
      const offer = JSON.parse(result);
      log("üì• Offer received, creating answer‚Ä¶");
      createPeer(false, offer);
    } catch {
      log("‚ùå Bad QR content");
    }
  });
};
</script>
</body>
</html>
